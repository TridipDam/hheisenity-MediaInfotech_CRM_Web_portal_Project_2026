// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

// User role type enum
enum UserRole {
  ADMIN
  STAFF
}

// Attendance Status enum
enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  REJECTED
}

// Attempt count enum
enum AttemptCount {
  ZERO
  ONE
  TWO
  THREE
}

// User model
model User {
  id         String   @id @default(cuid())
  name       String
  role       UserRole @default(STAFF)
  employeeId String   @unique
  email      String   @unique
  phone      String?
  teamId     String?
  status     String   @default("ACTIVE")
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  attendances           Attendance[]
  dailyLocations        DailyLocation[]
  attendanceOverrides   AttendanceOverride[] @relation("UserAttendanceOverrides")
  adminOverrides        AttendanceOverride[] @relation("AdminAttendanceOverrides")

  @@map("users")
}

// Daily location assignments for geofencing
model DailyLocation {
  id         String   @id @default(cuid())
  userId     String
  date       DateTime @db.Date
  latitude   Decimal  @db.Decimal(10, 8)
  longitude  Decimal  @db.Decimal(11, 8)
  radius     Int      @default(100) // meters
  address    String?
  city       String?
  state      String?
  startTime  DateTime
  endTime    DateTime
  assignedBy String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@map("daily_locations")
}

// Attendance records with location tracking
model Attendance {
  id               String           @id @default(cuid())
  userId           String
  date             DateTime         @db.Date
  clockIn          DateTime?
  
  // Location data
  latitude         Decimal?         @db.Decimal(10, 8)
  longitude        Decimal?         @db.Decimal(11, 8)
  location         String?          // Human-readable location
  
  // Device and network info
  ipAddress        String?
  deviceInfo       String?          // Browser, OS, Device type
  photo            String?          // Base64 or file path
  
  // Status and validation
  status           AttendanceStatus @default(PRESENT)
  attemptCount     AttemptCount     @default(ZERO)
  locked           Boolean @default(false)
  lockedReason     String   @db.Text

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
  @@index([date])
  @@index([status])
  @@map("attendances")
}

// Attendance overrides for admin corrections
model AttendanceOverride {
  id        String           @id @default(cuid())
  userId    String           // Foreign key field (String)
  date      DateTime         @db.Date
  adminId   String           // Foreign key field (String)
  oldStatus AttendanceStatus
  newStatus AttendanceStatus
  reason    String           @db.Text
  timestamp DateTime         @default(now())

  // Relations (User objects)
  user  User @relation("UserAttendanceOverrides", fields: [userId], references: [id], onDelete: Cascade)
  admin User @relation("AdminAttendanceOverrides", fields: [adminId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([adminId])
  @@index([date])
  @@map("attendance_overrides")
}